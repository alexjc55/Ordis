#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ eDAHouse

set -e

PROJECT_NAME="${1:-edahouse}"
DOMAIN="${2:-localhost}"
PORT="${3:-3000}"

echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ $PROJECT_NAME"
echo "üåê –î–æ–º–µ–Ω: $DOMAIN"
echo "üîå –ü–æ—Ä—Ç: $PORT"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 —Å—Ç–∞—Ç—É—Å
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PM2..."
if pm2 describe "$PROJECT_NAME" | grep -q "online"; then
    echo "‚úÖ PM2: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"
else
    echo "‚ùå PM2: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ"
    pm2 status "$PROJECT_NAME"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP –æ—Ç–≤–µ—Ç
echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."
if curl -f -s "http://localhost:$PORT/api/health" > /dev/null; then
    echo "‚úÖ HTTP: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã"
else
    echo "‚ùå HTTP: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo "–ü–æ–ø—Ä–æ–±—É–µ–º –±–∞–∑–æ–≤—ã–π URL..."
    if curl -f -s "http://localhost:$PORT" > /dev/null; then
        echo "‚ö†Ô∏è –ë–∞–∑–æ–≤—ã–π URL —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ /api/health –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    else
        echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
        exit 1
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo ""
echo "üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
if [ -f ".env" ]; then
    source .env
    if psql "$DATABASE_URL" -c "SELECT 1;" > /dev/null 2>&1; then
        echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
        exit 1
    fi
else
    echo "‚ö†Ô∏è –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ë–î"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo ""
echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É..."
required_dirs=("uploads" "logs" "backups")
for dir in "${required_dirs[@]}"; do
    if [ -d "$dir" ]; then
        echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $dir —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    else
        echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $dir –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º..."
        mkdir -p "$dir"
    fi
done

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo ""
echo "üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
if [ -w "uploads" ]; then
    echo "‚úÖ –ü—Ä–∞–≤–∞ –∑–∞–ø–∏—Å–∏ –≤ uploads"
else
    echo "‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ uploads"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤
echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤..."
if [ -d "logs" ]; then
    log_size=$(du -sh logs 2>/dev/null | cut -f1 || echo "0")
    echo "üìä –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤: $log_size"
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –ª–æ–≥–∏ –±–æ–ª—å—à–µ 100MB
    log_size_mb=$(du -m logs 2>/dev/null | cut -f1 || echo "0")
    if [ "$log_size_mb" -gt 100 ]; then
        echo "‚ö†Ô∏è –õ–æ–≥–∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞ ($log_size), —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
echo ""
echo "üíæ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏..."
memory_usage=$(pm2 describe "$PROJECT_NAME" | grep "memory usage" | awk '{print $4}' || echo "N/A")
if [ "$memory_usage" != "N/A" ]; then
    echo "üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: $memory_usage"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Nginx (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º Nginx..."
if command -v nginx &> /dev/null; then
    if sudo nginx -t > /dev/null 2>&1; then
        echo "‚úÖ Nginx: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    else
        echo "‚ùå Nginx: –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        sudo nginx -t
    fi
    
    if systemctl is-active nginx > /dev/null 2>&1; then
        echo "‚úÖ Nginx: –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
    else
        echo "‚ùå Nginx: –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    fi
else
    echo "‚ö†Ô∏è Nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–µ—Å–ª–∏ –¥–æ–º–µ–Ω –Ω–µ localhost)
if [ "$DOMAIN" != "localhost" ] && [ "$DOMAIN" != "127.0.0.1" ]; then
    echo ""
    echo "üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç..."
    if openssl s_client -connect "$DOMAIN:443" -servername "$DOMAIN" < /dev/null 2>/dev/null | grep -q "Verify return code: 0"; then
        echo "‚úÖ SSL: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω"
    else
        echo "‚ùå SSL: –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º"
    fi
fi

# –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
echo ""
echo "üéØ –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å: ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
echo ""
echo "üìä –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç:"
echo "   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –†–∞–±–æ—Ç–∞–µ—Ç"
echo "   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ü–æ–¥–∫–ª—é—á–µ–Ω–∞"
echo "   - –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞: –í –ø–æ—Ä—è–¥–∫–µ"
echo "   - –í–µ–±-—Å–µ—Ä–≤–µ—Ä: –ù–∞—Å—Ç—Ä–æ–µ–Ω"
echo ""
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   pm2 logs $PROJECT_NAME      - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo "   pm2 monit                   - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
echo "   pm2 restart $PROJECT_NAME   - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"